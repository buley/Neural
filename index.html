<html>
	<head>
		<title>Neural.js</title>
		<!--<link rel="stylesheet" href="/css/style.css">-->
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
	</head>
	<body>
		<div id="result"></div>
		<script type="text/javascript">

			var test = test || {};
			test.synapses = test.synapses || {};
			test.synapses.cursor = test.synapses.cursor || {};
			test.neurons = test.neurons || {};
			test.neurons.cursor = test.neurons.cursor || {};

			var test_id = 1;
			var inc_amount = 1;

			function add_data() {
				var count = 3;
				var map = [];
				for( var i = 0; i < count; i++ ) {
				/*	Neural.neurons.add( { 'type': 'hidden', 'slug': InDB.utilities.random( 12, 'letters' ), 'display': InDB.utilities.random( 12, 'letters' ) }, function( context ) {
						var value = InDB.row.value( context );
			*///			console.log( 'Added index @', value );
						var node = Math.floor( Math.random()*100 );	
						Neural.synapses.add( { 'data': { 'type': 'connection', 'from': 1, 'to': node, 'strength': Math.random() }, 'on_success': function( context ) {
							console.log( 'Added synapses from ' + '1' + ' to ' + node );
						}, 'on_error': function( context ) {
							console.log( 'FAILED to add synapses', context );       
						} } );
			//		} );
				}
			}

			test.synapses.getStrength = function( test_callback ) {
				var on_error = function( test_callback ) {
					console.log( 'test.synapses.getStrength(): failed' );
					if( 'function' !== typeof test_callback ) {
						test_callback( value );
					}
				};
				Neural.synapses.getStrength( {
					'key': test_id
					, 'index': 'id'
					, 'on_success': function( value ) {	
						if( 'undefined' !== value ) {
							console.log( 'test.synapses.getStrength(): passed' );
						} else {
							console.log( 'test.synapses.getStrength(): failed' );
						}
						if( 'function' !== typeof test_callback ) {
							test_callback( value );
						}
					}, 'on_error': on_error
				} );
				

			};

			test.synapses.setStrength = function( test_callback ) {

				var on_error = function( value ) {
					console.log( 'test.synapses.setStrength(): failed' );
					if( 'function' !== typeof test_callback ) {
						test_callback( value );
					}
				};
				Neural.synapses.getStrength( {
					'key': test_id
					, 'index': 'id'
					, 'on_success': function( context ) {	
						var value = InDB.row.value( context.event );	
						var expected =  {};
						var key = Neural.synapses.shorthand( 'strength' );
					       	expected[ key ] = value[ key ];
						Neural.synapses.setStrength( {
							'key': test_id
							, 'index': 'id'
							, 'expecting': expected
							, 'strength': function( current ) {
								var replacement = current / 2;
								replacement = ( !!replacement && replacement > .001 ) ? replacement : 1;
								return replacement;
							}, 'on_success': function( context ) {
								Neural.synapses.getStrength( {
									'key': test_id
									, 'index': 'id'
									, 'on_success': function( value ) {
										if( 'undefined' !== typeof value ) {
											console.log( 'test.synapses.setStrength(): passed' );
										} else {
											console.log( 'test.synapses.setStrength(): failed' );
										}
										if( 'function' !== typeof test_callback ) {
											test_callback( value );
										}
									}, 'on_error': on_error 
								} );
							}, 'on_error': on_error
						} );

					}, 'on_error': on_error
				} );
				

			};

	
			test.synapses.get = function( test_callback ) {

				var on_error = function( get_context ) {
					console.log( 'test.synapses.get(): failed' );
					if( 'function' == typeof test_callback ) {
						test_callback( get_context );
					}
				};
				Neural.synapses.get( {
					'key': test_id
					, 'index': 'id'
					, 'on_success': function( value ) {	
						console.log( 'test.synapses.get(): passed' );
						if( 'function' == typeof test_callback ) {
							test_callback( value );
						}
					}, 'on_error': on_error
				} );
				

			};

			test.synapses.put = function( test_callback ) {

				var on_error = function( value ) {
					console.log( 'test.synapses.put(): failed' );
					if( 'function' == typeof test_callback ) {
						test_callback( value );
					}
				};
				Neural.synapses.get( {
					'key': test_id
					, 'index': 'id'
					, 'on_success': function( new_value ) {
						new_value[ 'from' ] = ( isNaN( new_value[ 'from' ] ) ) ? 1 : new_value[ 'from' ];
						new_value[ 'from' ] = parseInt( new_value[ 'from' ], 10 ) + inc_amount;
						new_value[ 'to' ] = ( isNaN( new_value[ 'to' ] ) ) ? 1 : new_value[ 'to' ];
						new_value[ 'to' ] = parseInt( new_value[ 'to' ], 10 ) + inc_amount;
						Neural.synapses.put( {
							'key': test_id
							, 'data': new_value
							, 'on_success': function( result_id ) {
								Neural.synapses.get( {
									'key': result_id
									//, 'index': 'id'
									, 'on_success': function( return_value ) {
										if( 'undefined' !== typeof return_value[ 'from' ] && new_value[ 'from' ] == return_value[ 'from' ] && 'undefined' !== typeof return_value[ 'to' ] && new_value[ 'to' ] == return_value[ 'to' ] ) {	
											console.log( 'test.synapses.put(): passed' );
										} else {
											console.log( 'test.synapses.put(): failed', new_value, return_value );
										}
										if( 'function' == typeof test_callback ) {
											test_callback( return_value );
										}							
									}, 'on_error': on_error 
								} );
							}, 'on_error': on_error
						} );

					}, 'on_error': on_error
				} );	

			};

			test.synapses.add = function( test_callback ) {

				var on_error = function( value ) {
					console.log( 'test.synapses.add(): failed' );
					if( 'function' == typeof test_callback ) {
						test_callback( value );
					}
				};
				var new_value = {
					'to': 1
					, 'from': 1
					, 'type': 'connection'
					, 'strength': Math.random()
				};
				Neural.synapses.add( {
					'data': new_value
					, 'on_success': function( add_value ) {
						Neural.synapses.get( {
							'key': add_value
							//, 'index': 'id'
							, 'on_success': function( return_value ) {
								if( 'undefined' !== typeof return_value && null !== return_value && add_value == return_value.id ) {
									test_id = return_value;
									console.log( 'test.synapses.add(): passed' );
								} else {
									console.log( 'test.synapses.add(): failed' );
								}
								if( 'function' == typeof test_callback ) {
									test_callback( return_value );
								}							
							}, 'on_error': on_error 
						} );
					}, 'on_error': on_error
				} );

			};


			test.synapses.update = function( test_callback ) {

				var on_error = function( value ) {
					console.log( 'test.synapses.update(): failed' );
					if( 'function' == typeof test_callback ) {
						test_callback( value );
					}
				};
				Neural.synapses.get( {
					'key': test_id
					//, 'index': 'id'
					, 'on_success': function( value ) {	
						var expected =  {};
						expected[ 'to' ] = value[ 'to' ];
						Neural.synapses.update( {
							'key': test_id
							//, 'index': 'id'
							, 'expecting': expected
							, 'data': function( current ) {
								var val = {};
								val[ 'to' ] = parseInt( current[ 'to' ], 10 ) + inc_amount;
								return val;
							}, 'on_success': function( context ) {
								Neural.synapses.get( {
									'key': test_id
									//, 'index': 'id'
									, 'on_success': function( returned_value ) {
										if( 'undefined' !== typeof returned_value && null !== returned_value && ( returned_value[ 'to' ] - inc_amount )  == expected[ 'to' ] ) {
											console.log( 'test.synapses.update(): passed' );
										} else {
											console.log( 'test.synapses.update(): failed' );
										}
										if( 'function' == typeof test_callback ) {
											test_callback( returned_value );
										}
									}, 'on_error': on_error 
								} );
							}, 'on_error': on_error
						} );

					}, 'on_error': on_error
				} );
				

			};

			test.synapses.delete = function( test_callback ) {

				var on_error = function( value ) {
					console.log( 'test.synapses.delete(): failed' );
					if( 'function' == typeof test_callback ) {
						test_callback( value );
					}
				};
				var new_value = {
					'to': 1
					, 'from': 1
					, 'type': 'connection'
					, 'strength': Math.random()
				};
				Neural.synapses.add( {
					'data': new_value
					, 'on_success': function( add_value ) {
						Neural.synapses.get( {
							'key': add_value
							//, 'index': 'id'
							, 'on_success': function( get_value_1 ) {
								Neural.synapses.delete( {
									'key': add_value
									, 'on_success': function( delete_value ) {
										Neural.synapses.get( {
											'key': add_value
											//, 'index': 'id'
											, 'on_success': on_error //should be missing
											, 'on_error': function( context ) {
												var get_value_2 = InDB.row.value( context );
												console.log("AFTER DELETE",get_value_2);
												if( 'undefined' !== typeof get_value_2 && null == get_value_2 ) {
													console.log( 'test.synapses.delete(): passed' );
												} else {
													console.log( 'test.synapses.delete(): failed' );
												}
												if( 'function' == typeof test_callback ) {
													test_callback( get_value_2 );
												}
											} 
										} );
									}, 'on_error': on_error } );
							}, 'on_error': on_error } );
					}, 'on_error': on_error } );
			};

			/* Cursor */


			test.synapses.cursor.update = function() {

				var on_error = function( context ) {
					console.log( 'test.synapses.getStrength(): failed' );
				};
				var before = {};
				var after = {};
				Neural.synapses.getStrength( {
					'key': test_id
					, 'index': 'id'
					, 'on_success': function( context ) {	
						var value = InDB.row.value( context.event );	
						console.log( 'test.synapses.getStrength(): passed' );
					}, 'on_error': on_error
				} );
				

			};


			$(document).ready(function() {
				var Neural = Neural || {};
				Neural.database_name = "Neural-015";
				Neural.database_description = "Basic MLP neural network."
				var browser_check = InDB.checkBrowser();
				InDB.assert( -1 !== browser_check, 'incompatible browser' );
				if ( 0 === browser_check ) {
					InDB.fixBrowser();
				}
				var debug = true;
				InDB.debug = debug;
				Neural.debug = debug;
				var on_loaded = function( context ) {
					jQuery( document ).trigger( 'neuron_database_loaded', context );
				}
				InDB.trigger( 'InDB_do_database_load', { 'name': Neural.database_name, 'description': Neural.database_description, 'on_success': on_loaded } ) ;
			});
	

			jQuery( document ).bind( 'neuron_database_loaded', function( context ) {
				console.log( "Neuron InDB is loaded", context );
				
				var get_test = function( context ) {
					test.synapses.get( put_test );
				};
				var put_test = function( context ) {
					test.synapses.put( update_test );
				};
				var update_test = function( context ) {
					test.synapses.update( add_test );
				};
				var add_test = function( context ) {
					test.synapses.add( delete_test );
				};
				var delete_test = function( context ) {
					test.synapses.delete( clear_test );
				};
				var clear_test = function( context ) {
					console.log('clear test');	
				}

				get_test();

				//test.synapses.getStrength();
				//test.synapses.setStrength();
				/* 
				test.synapses.cursor.delete();
				test.synapses.cursor.get();
				test.synapses.cursor.update();			
				*/

			} );
		</script>
		<script type="text/javascript" src="http://github.com/editor/InDB/raw/master/indb.dev.js"></script>
		<script type="text/javascript" src="https://github.com/editor/Neural/raw/master/neural.dev.js"></script>
	</body>
</html>

